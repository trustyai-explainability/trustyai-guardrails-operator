---
# First, create a ConfigMap with your NeMo Guardrails configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: example-nemo-config-per-tool
data:
  config.yaml: |
    rails:
      config:
        huggingface_detector:
          models:
            - model_repo: "ibm-granite/granite-guardian-hap-38m"
              blocked_classes: [1]
              descriptor: "hate speech"
            - model_repo: "protectai/deberta-v3-base-prompt-injection-v2"
              blocked_classes: ["INJECTION"]
              descriptor: "prompt injection"
        sensitive_data_detection:
          input:
            entities: 
              - PERSON
              - EMAIL_ADDRESS
              - PHONE_NUMBER
              - CREDIT_CARD
              - US_SSN
              - IBAN_CODE
      tool_input: # these are guardrails on data coming *out* of a tool that will be LLM *input*, hence the confusing "tool_input" name
        flows:
          - per tool guardrails
  rails.co: |
    define flow detect sensitive data on tool input
      """Check if the tool input has any sensitive data."""
      $has_sensitive_data = execute detect_sensitive_data(source="input", text=$tool_message)
      
      if $has_sensitive_data
        bot inform answer unknown
        stop
    
    define flow block forbidden tool
      bot inform answer unknown
      stop
  
    define flow per tool guardrails
      if $tool_name == "tool_needs_pii_checks"
        do detect sensitive data on tool input
      else if $tool_name == "tool_needs_hap_checks"
        $hf_model = "ibm-granite/granite-guardian-hap-38m"
        do huggingface detector check tool input 
      else if $tool_name == "tool_needs_prompt_injection_checks"
        $hf_model = "protectai/deberta-v3-base-prompt-injection-v2"
        do huggingface detector check tool input 
      else
        do block forbidden tool
        stop

---
# Then create the NemoGuardrails resource
apiVersion: trustyai.opendatahub.io/v1alpha1
kind: NemoGuardrails
metadata:
  name: example-per-tool-nemoguardrails
spec:
  nemoConfigs:
    - name: main-config
      configMaps:
        - example-nemo-config-per-tool
      default: true

  # Optional: Add environment variables
  env:
    - name: LOG_LEVEL
      value: "INFO"
    - name: PORT
      value: "8000"

  # Optional: Configure CA bundle for custom certificates
  # caBundleConfig:
  #   configMapName: custom-ca-bundle
  #   configMapKeys:
  #     - ca-bundle.crt

---
# Optional: Enable authentication with kube-rbac-proxy
# Add this annotation to the NemoGuardrails resource metadata
# annotations:
#   security.opendatahub.io/enable-auth: "true"
